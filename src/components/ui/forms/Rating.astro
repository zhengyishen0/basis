---
import { Star } from 'lucide-astro';
import { cn } from '@/lib/utils';
import { createUIComponent, type UIComponentProps } from '@/lib/component-variants';

const ratingVariants = createUIComponent(
  'flex flex-col items-center gap-2 text-muted-foreground [&_.rating-star[data-filled="true"]]:text-warning [&_.rating-star:hover]:text-warning/80',
  {
    size: {
      sm: '[&_.stars-container]:gap-1 [&_.rating-star]:w-4 [&_.rating-star]:h-4',
      md: '[&_.stars-container]:gap-1.5 [&_.rating-star]:w-5 [&_.rating-star]:h-5',
      lg: '[&_.stars-container]:gap-2 [&_.rating-star]:w-6 [&_.rating-star]:h-6'
    }
  }
);

export interface Props extends UIComponentProps {
  maxStars?: number;
  initialValue?: number;
  disabled?: boolean;
  readonly?: boolean;
  name?: string;
}

const { 
  maxStars = 5,
  initialValue = 0,
  disabled = false,
  readonly = false,
  name,
  size = 'md',
  padding = 'none',
  margin = 'none',
  elevation = 'none',
  overflow = 'fixed',
  class: className,
  ...alpineProps
} = Astro.props;
---

<div 
  x-data={`{
    disabled: ${disabled},
    readonly: ${readonly},
    maxStars: ${maxStars},
    stars: 0,
    value: ${initialValue},
    
    hoverStar(star) {
      if (this.disabled || this.readonly) return;
      this.stars = star;
    },
    
    mouseLeftStar() {
      if (this.disabled || this.readonly) return;
      this.stars = this.value;
    },
    
    rate(star) {
      if (this.disabled || this.readonly) return;
      this.value = star;
      this.stars = star;
      if (this.$refs.hiddenInput) {
        this.$refs.hiddenInput.value = star;
        this.$refs.hiddenInput.dispatchEvent(new Event('change'));
      }
      this.$el.dispatchEvent(new CustomEvent('rating-changed', { 
        detail: star,
        bubbles: true 
      }));
    },
    
    reset() {
      if (this.disabled || this.readonly) return;
      this.value = 0;
      this.stars = 0;
      if (this.$refs.hiddenInput) {
        this.$refs.hiddenInput.value = 0;
        this.$refs.hiddenInput.dispatchEvent(new Event('change'));
      }
      this.$el.dispatchEvent(new CustomEvent('rating-changed', { 
        detail: 0,
        bubbles: true 
      }));
    }
  }`}
  x-init="stars = value"
  x-modelable="value"
  {...alpineProps}
  class={cn(ratingVariants({ size, padding, margin, elevation, overflow }), className)}
>
  {name && (
    <input 
      x-ref="hiddenInput"
      type="hidden" 
      name={name}
      :value="value"
    />
  )}
  
  <div class="stars-container flex items-center">
    <template x-for="star in maxStars" :key="star">
    <button 
      @click="rate(star)"
      @mouseenter="hoverStar(star)"
      @mouseleave="mouseLeftStar()"
      :disabled="disabled"
      :data-filled="(stars >= star) || (value >= star && stars === 0)"
      :class="{
        'cursor-pointer': !disabled && !readonly,
        'cursor-not-allowed opacity-50': disabled,
        'cursor-default': readonly
      }"
      class="rating-star focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 rounded-sm transition-all duration-200 hover:scale-110 disabled:hover:scale-100"
      type="button"
      :aria-label="`Rate ${star} out of ${maxStars} stars`"
    >
      <Star class="transition-colors duration-200" fill="currentColor" />
    </button>
    </template>
  </div>
  
  <div 
    @click="reset()" 
    class="flex items-center cursor-pointer"
    :class="{ 'opacity-50 cursor-not-allowed': disabled || readonly }"
  >
    <slot />
  </div>
</div>